<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“¦ AI + æ‰‹å‹•è£œé»è¨ˆæ•¸</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<style>
body {
  margin: 0;
  padding: 16px;
  background: #020617;
  color: #e5e7eb;
  font-family: system-ui, sans-serif;
  text-align: center;
}

button {
  padding: 12px 16px;
  margin: 6px;
  font-size: 16px;
  border-radius: 12px;
  border: none;
  font-weight: bold;
}

.gallery { background:#38bdf8; }
.camera  { background:#facc15; }
.ai      { background:#22c55e; }
.clear   { background:#ef4444; }
.export  { background:#a855f7; }

canvas {
  max-width: 100%;
  margin-top: 14px;
  border-radius: 14px;
  background:#000;
}

details { margin: 10px 0; text-align:left; }
summary { cursor:pointer; font-weight:bold; }

fieldset {
  border:1px solid #334155;
  border-radius:12px;
  padding:10px;
}

label { display:inline-block; margin:4px 8px; font-size:14px; }

#result { margin-top:10px; font-size:18px; }
</style>
</head>

<body>

<h2>ğŸ“¦ AI + æ‰‹å‹•è£œé»è¨ˆæ•¸</h2>

<button id="selectAllBtn">âœ… å…¨é¸</button>
<button id="deselectAllBtn">â›” å…¨ä¸é¸</button>

<details open>
<summary>ğŸš— äº¤é€šå·¥å…·</summary>
<fieldset>
<label><input type="checkbox" value="car" checked> car</label>
<label><input type="checkbox" value="truck" checked> truck</label>
<label><input type="checkbox" value="bus" checked> bus</label>
<label><input type="checkbox" value="motorcycle" checked> motorcycle</label>
<label><input type="checkbox" value="bicycle" checked> bicycle</label>
</fieldset>
</details>

<div>
<button class="gallery" id="btnGallery">ğŸ–¼ ç›¸ç°¿</button>
<button class="camera" id="btnCamera">ğŸ“¸ ç›¸æ©Ÿ</button>
</div>

<div>
<button class="ai" id="aiBtn" disabled>ğŸ¤– AI åµæ¸¬</button>
<button class="clear" id="clearBtn">ğŸ§¹ æ¸…é™¤</button>
<button class="export" id="exportBtn">ğŸ“¤ åŒ¯å‡º</button>
</div>

<div id="result">â³ è¼‰å…¥æ¨¡å‹ä¸­â€¦</div>
<canvas id="canvas"></canvas>

<input type="file" accept="image/*" hidden id="fileInput">
<input type="file" accept="image/*" capture="environment" hidden id="cameraInput">

<script>
/* ===== åƒæ•¸å€ï¼ˆä¸€æ¬¡èª¿æ•´å…¨ç”Ÿæ•ˆï¼‰ ===== */
const POINT_RADIUS = 20;
const HIT_RADIUS = 36;
const CLUSTER_DISTANCE = 80;

/* ===== åŸºæœ¬ç‰©ä»¶ ===== */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const result = document.getElementById("result");
const aiBtn = document.getElementById("aiBtn");

let img = new Image();
let model;
let points = [];

/* ===== å…¨é¸ / å…¨ä¸é¸ ===== */
selectAllBtn.onclick = () =>
  document.querySelectorAll("input[type=checkbox]").forEach(c => c.checked = true);
deselectAllBtn.onclick = () =>
  document.querySelectorAll("input[type=checkbox]").forEach(c => c.checked = false);

function getSelectedClasses() {
  return new Set([...document.querySelectorAll("input[type=checkbox]:checked")]
    .map(c => c.value));
}

/* ===== åˆå§‹åŒ–æ¨¡å‹ ===== */
async function init() {
  await tf.ready();
  await tf.setBackend("webgl");
  model = await cocoSsd.load();
  aiBtn.disabled = false;
  result.textContent = "âœ… æ¨¡å‹å°±ç·’";
}
window.onload = init;

/* ===== è¼‰å…¥åœ–ç‰‡ ===== */
function loadImage(file) {
  const reader = new FileReader();
  reader.onload = () => {
    img.onload = () => {
      canvas.width = img.width;
      canvas.height = img.height;
      points = [];
      redraw();
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(file);
}

btnGallery.onclick = () => fileInput.click();
btnCamera.onclick = () => cameraInput.click();
fileInput.onchange = e => loadImage(e.target.files[0]);
cameraInput.onchange = e => loadImage(e.target.files[0]);

/* ===== AI åµæ¸¬ï¼ˆä¸æœƒé‡è¤‡ç´¯åŠ ï¼‰ ===== */
aiBtn.onclick = async () => {
  const selected = getSelectedClasses();
  const manual = points.filter(p => p.source === "MANUAL");
  const preds = await model.detect(img);

  const raw = preds.filter(p => selected.has(p.class))
    .map(p => ({
      x: p.bbox[0] + p.bbox[2]/2,
      y: p.bbox[1] + p.bbox[3]/2
    }));

  const clustered = cluster(raw);
  points = [...manual, ...clustered.map(p => ({...p, source:"AI"}))];
  redraw();
};

/* ===== åˆ†ç¾¤ ===== */
function cluster(arr) {
  const out = [];
  arr.forEach(p => {
    const c = out.find(o => Math.hypot(o.x-p.x,o.y-p.y) < CLUSTER_DISTANCE);
    if (c) {
      c.x = (c.x + p.x)/2;
      c.y = (c.y + p.y)/2;
    } else out.push(p);
  });
  return out;
}

/* ===== é»æ“Šæ–°å¢ / åˆªé™¤ ===== */
canvas.onclick = e => {
  const r = canvas.getBoundingClientRect();
  const x = (e.clientX - r.left) * canvas.width / r.width;
  const y = (e.clientY - r.top) * canvas.height / r.height;

  const i = points.findIndex(p => Math.hypot(p.x-x,p.y-y) < HIT_RADIUS);
  i >= 0 ? points.splice(i,1) : points.push({x,y,source:"MANUAL"});
  redraw();
};

clearBtn.onclick = () => { points = []; redraw(); };

exportBtn.onclick = () => {
  const a = document.createElement("a");
  a.download = `count_${points.length}.png`;
  a.href = canvas.toDataURL();
  a.click();
};

/* ===== é‡ç¹ª ===== */
function redraw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (img.src) ctx.drawImage(img,0,0);

  points.forEach((p,i)=>{
    ctx.beginPath();
    ctx.arc(p.x,p.y,POINT_RADIUS,0,Math.PI*2);
    ctx.fillStyle = p.source==="AI" ? "#22c55e" : "#f97316";
    ctx.fill();

    ctx.fillStyle="#fff";
    ctx.font="16px sans-serif";
    ctx.fillText(i+1, p.x+POINT_RADIUS+6, p.y+6);
  });

  result.textContent = `ğŸ”¢ ç¸½æ•¸ï¼š${points.length}`;
}
</script>

</body>
</html>
