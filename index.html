<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“¦ AI + æ‰‹å‹•è£œé»è¨ˆæ•¸</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<style>
#selectAllBtn { background:#16a34a; }
#deselectAllBtn { background:#475569; }

details { margin: 10px 0; }
summary {
  cursor: pointer;
  font-weight: bold;
  font-size: 16px;
  padding: 6px 4px;
}
summary::marker { color: #38bdf8; }

body {
  margin: 0;
  padding: 16px;
  background: #020617;
  color: #e5e7eb;
  font-family: system-ui, sans-serif;
  text-align: center;
}

h2 { margin-bottom: 10px; }

button {
  padding: 12px 16px;
  margin: 6px;
  font-size: 16px;
  border-radius: 12px;
  border: none;
  font-weight: bold;
}

.gallery { background:#38bdf8; }
.camera  { background:#facc15; }
.ai      { background:#22c55e; }
.clear   { background:#ef4444; }
.export  { background:#a855f7; }

canvas {
  max-width: 100%;
  margin-top: 14px;
  border-radius: 14px;
  background:#000;
}

#result { margin-top: 10px; font-size: 18px; }

fieldset {
  border: 1px solid #334155;
  border-radius: 12px;
  margin: 10px 0;
  padding: 10px;
  text-align: left;
}

label {
  display: inline-block;
  margin: 4px 8px;
  font-size: 14px;
}
</style>
</head>

<body>

<h2>ğŸ“¦ AI + æ‰‹å‹•è£œé»è¨ˆæ•¸</h2>

<div style="margin-bottom:10px;">
  <button id="selectAllBtn">âœ… å…¨é¸é¡å‹</button>
  <button id="deselectAllBtn">â›” å…¨ä¸é¸</button>
</div>

<details>
  <summary>ğŸ‘¤ äººèˆ‡å‹•ç‰©</summary>
  <fieldset>
    <label><input type="checkbox" value="person"> äºº person</label>
    <label><input type="checkbox" value="dog"> ç‹— dog</label>
    <label><input type="checkbox" value="cat"> è²“ cat</label>
    <label><input type="checkbox" value="horse"> é¦¬ horse</label>
    <label><input type="checkbox" value="cow"> ç‰› cow</label>
    <label><input type="checkbox" value="sheep"> ç¾Š sheep</label>
  </fieldset>
</details>

<details open>
  <summary>ğŸš— äº¤é€šå·¥å…·ï¼ˆé è¨­ï¼‰</summary>
  <fieldset>
    <label><input type="checkbox" value="car" checked> car</label>
    <label><input type="checkbox" value="truck" checked> truck</label>
    <label><input type="checkbox" value="bus" checked> bus</label>
    <label><input type="checkbox" value="motorcycle" checked> motorcycle</label>
    <label><input type="checkbox" value="bicycle" checked> bicycle</label>
  </fieldset>
</details>

<details>
  <summary>ğŸ‘œ éš¨èº«ç‰©å“</summary>
  <fieldset>
    <label><input type="checkbox" value="backpack"> backpack</label>
    <label><input type="checkbox" value="handbag"> handbag</label>
    <label><input type="checkbox" value="suitcase"> suitcase</label>
  </fieldset>
</details>

<details>
  <summary>ğŸ½ ç”Ÿæ´»ç”¨å“</summary>
  <fieldset>
    <label><input type="checkbox" value="chair"> chair</label>
    <label><input type="checkbox" value="dining table"> table</label>
    <label><input type="checkbox" value="tv"> tv</label>
    <label><input type="checkbox" value="laptop"> laptop</label>
    <label><input type="checkbox" value="cell phone"> phone</label>
  </fieldset>
</details>

<div>
  <button class="gallery" id="btnGallery">ğŸ–¼ ç›¸ç°¿</button>
  <button class="camera" id="btnCamera">ğŸ“¸ ç›¸æ©Ÿ</button>
</div>

<div>
  <button class="ai" id="aiBtn" disabled>ğŸ¤– AI åˆæ­¥åµæ¸¬</button>
  <button class="clear" id="clearBtn">ğŸ§¹ æ¸…é™¤æ¨™è¨˜</button>
  <button class="export" id="exportBtn">ğŸ“¤ åŒ¯å‡ºåœ–ç‰‡ + æ•¸é‡</button>
</div>

<div id="result">â³ è¼‰å…¥æ¨¡å‹ä¸­â€¦</div>
<canvas id="canvas"></canvas>

<input type="file" accept="image/*" hidden id="fileInput">
<input type="file" accept="image/*" capture="environment" hidden id="cameraInput">

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const result = document.getElementById("result");
const aiBtn = document.getElementById("aiBtn");

const selectAllBtn = document.getElementById("selectAllBtn");
const deselectAllBtn = document.getElementById("deselectAllBtn");

let img = new Image();
let model;
let points = [];
const CLUSTER_DISTANCE = 80;

/* ===== å…¨é¸ / å…¨ä¸é¸ï¼ˆæ­£ç¢ºä½ç½®ï¼‰===== */
selectAllBtn.onclick = () => {
  document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
};

deselectAllBtn.onclick = () => {
  document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
};

/* å–å¾—å‹¾é¸é¡å‹ */
function getSelectedClasses() {
  return new Set(
    [...document.querySelectorAll("input[type=checkbox]:checked")]
      .map(cb => cb.value)
  );
}

/* åˆå§‹åŒ– */
async function init() {
  await tf.ready();
  await tf.setBackend("webgl");
  model = await cocoSsd.load();
  result.textContent = "âœ… æ¨¡å‹å°±ç·’ï¼Œè«‹è¼‰å…¥ç…§ç‰‡";
  aiBtn.disabled = false;
}
window.onload = init;

/* è¼‰å…¥åœ–ç‰‡ */
function loadImage(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    img.onload = () => {
      canvas.width = img.width;
      canvas.height = img.height;
      points = [];
      redraw();
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(file);
}

btnGallery.onclick = () => fileInput.click();
btnCamera.onclick = () => cameraInput.click();
fileInput.onchange = e => loadImage(e.target.files[0]);
cameraInput.onchange = e => loadImage(e.target.files[0]);

/* AI åµæ¸¬ */
aiBtn.onclick = async () => {
  if (!img.src) return;

  const selected = getSelectedClasses();
  const manual = points.filter(p => p.source === "MANUAL");
  const preds = await model.detect(img);

  const raw = [];
  preds.forEach(p => {
    if (!selected.has(p.class)) return;
    const [x, y, w, h] = p.bbox;
    if (w > 60 && h > 60) raw.push({ x: x + w / 2, y: y + h / 2 });
  });

  const clustered = clusterPoints(raw, CLUSTER_DISTANCE);
  points = [...manual, ...clustered.map(p => ({ ...p, source: "AI" }))];
  redraw();
};

/* åˆ†ç¾¤ */
function clusterPoints(raw, dist) {
  const clusters = [];
  raw.forEach(pt => {
    let found = false;
    for (const c of clusters) {
      if (Math.hypot(c.x - pt.x, c.y - pt.y) < dist) {
        c.x = (c.x * c.count + pt.x) / (c.count + 1);
        c.y = (c.y * c.count + pt.y) / (c.count + 1);
        c.count++;
        found = true;
        break;
      }
    }
    if (!found) clusters.push({ x: pt.x, y: pt.y, count: 1 });
  });
  return clusters;
}

/* é»æ“Šæ–°å¢ / åˆªé™¤ */
canvas.onclick = e => {
  const r = canvas.getBoundingClientRect();
  const x = (e.clientX - r.left) * canvas.width / r.width;
  const y = (e.clientY - r.top) * canvas.height / r.height;

  const i = points.findIndex(p => Math.hypot(p.x - x, p.y - y) < 18);
  if (i >= 0) points.splice(i, 1);
  else points.push({ x, y, source: "MANUAL" });
  redraw();
};

/* æ¸…é™¤ */
clearBtn.onclick = () => { points = []; redraw(); };

/* åŒ¯å‡º */
exportBtn.onclick = () => {
  const link = document.createElement("a");
  link.download = `count_${points.length}.png`;
  link.href = canvas.toDataURL();
  link.click();
};

/* é‡ç¹ª */
function redraw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img,0,0);
  points.forEach((p,i)=>{
    ctx.beginPath();
    ctx.arc(p.x,p.y,10,0,Math.PI*2);
    ctx.fillStyle = p.source==="AI"?"#22c55e":"#f97316";
    ctx.fill();
    ctx.fillStyle="#fff";
    ctx.fillText(i+1,p.x+12,p.y+4);
  });
  result.textContent = `ğŸ”¢ ç¸½æ•¸ï¼š${points.length}`;
}
</script>

</body>
</html>

